#!/bin/bash

# Code quality and linting script
# Runs all code quality checks

set -e

echo "ğŸ” Running Code Quality Checks"

# Ensure we're in the Rails root
if [ ! -f "Gemfile" ]; then
    echo "âŒ No Gemfile found. Please run this script from the Rails application root."
    exit 1
fi

echo "ğŸ“¦ Installing dependencies..."
bundle install --quiet

# Initialize error tracking
errors=0

# Run RuboCop
echo "ğŸš¨ Running RuboCop..."
if bundle exec rubocop; then
    echo "âœ… RuboCop passed"
else
    echo "âŒ RuboCop failed"
    errors=$((errors + 1))
fi

# Run Brakeman security scan
echo "ğŸ”’ Running Brakeman security scan..."
if bundle exec brakeman --exit-on-warn; then
    echo "âœ… Brakeman security scan passed"
else
    echo "âŒ Brakeman security scan failed"
    errors=$((errors + 1))
fi

# Run Bundle Audit for gem vulnerabilities
echo "ğŸ” Checking for gem vulnerabilities..."
if bundle exec bundle-audit check --update; then
    echo "âœ… No gem vulnerabilities found"
else
    echo "âŒ Gem vulnerabilities detected"
    errors=$((errors + 1))
fi

# Check for Rails best practices (if rails_best_practices gem is available)
if gem list rails_best_practices -i >/dev/null 2>&1; then
    echo "ğŸ“‹ Running Rails Best Practices check..."
    if bundle exec rails_best_practices; then
        echo "âœ… Rails Best Practices check passed"
    else
        echo "âŒ Rails Best Practices check failed"
        errors=$((errors + 1))
    fi
fi

# Check for dead code (if reek gem is available)
if gem list reek -i >/dev/null 2>&1; then
    echo "ğŸ‘ƒ Running Reek code smell detection..."
    if bundle exec reek; then
        echo "âœ… No code smells detected"
    else
        echo "âš ï¸  Code smells detected (warnings only)"
    fi
fi

# JavaScript/CSS linting (if available)
if [ -f "package.json" ]; then
    echo "ğŸ¨ Running JavaScript/CSS linting..."

    # ESLint
    if yarn list eslint >/dev/null 2>&1; then
        if yarn run eslint app/javascript/; then
            echo "âœ… ESLint passed"
        else
            echo "âŒ ESLint failed"
            errors=$((errors + 1))
        fi
    fi

    # Stylelint
    if yarn list stylelint >/dev/null 2>&1; then
        if yarn run stylelint "app/assets/stylesheets/**/*.scss"; then
            echo "âœ… Stylelint passed"
        else
            echo "âŒ Stylelint failed"
            errors=$((errors + 1))
        fi
    fi
fi

# Summary
echo ""
echo "ğŸ“Š Code Quality Summary"
echo "======================"

if [ $errors -eq 0 ]; then
    echo "ğŸ‰ All code quality checks passed!"
    exit 0
else
    echo "âŒ $errors code quality check(s) failed."
    echo ""
    echo "To fix issues:"
    echo "  - RuboCop: Run 'bundle exec rubocop -a' to auto-fix"
    echo "  - Brakeman: Review security warnings and fix manually"
    echo "  - Bundle Audit: Update vulnerable gems"
    echo ""
    exit 1
fi
