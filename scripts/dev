#!/bin/bash

# Development server startup script
# This script starts all necessary services for development

set -e

echo "ğŸš€ Starting Ruby on Rails Blog Development Environment"

# Check if required commands exist
command -v ruby >/dev/null 2>&1 || { echo "âŒ Ruby is required but not installed. Aborting." >&2; exit 1; }
command -v bundle >/dev/null 2>&1 || { echo "âŒ Bundler is required but not installed. Aborting." >&2; exit 1; }
command -v yarn >/dev/null 2>&1 || { echo "âŒ Yarn is required but not installed. Aborting." >&2; exit 1; }

# Check if we're in the right directory
if [ ! -f "Gemfile" ]; then
    echo "âŒ No Gemfile found. Please run this script from the Rails application root."
    exit 1
fi

echo "ğŸ“¦ Installing dependencies..."

# Install Ruby gems
echo "Installing Ruby gems..."
bundle install

# Install JavaScript packages
echo "Installing JavaScript packages..."
yarn install

# Setup database if it doesn't exist
if [ ! -f "db/development.sqlite3" ] && [ ! -d "db/migrate" ]; then
    echo "ğŸ—„ï¸  Setting up database..."
    bundle exec rails db:create
    bundle exec rails db:migrate
    bundle exec rails db:seed
fi

# Start services in the background
echo "ğŸ”§ Starting services..."

# Start Redis (if available)
if command -v redis-server >/dev/null 2>&1; then
    echo "Starting Redis..."
    redis-server --daemonize yes
fi

# Start Sidekiq in the background
if bundle show sidekiq >/dev/null 2>&1; then
    echo "Starting Sidekiq..."
    bundle exec sidekiq -d
fi

# Compile assets
echo "ğŸ“¦ Compiling assets..."
bundle exec rails assets:precompile

# Start the Rails server
echo "ğŸŒ Starting Rails server on http://localhost:3000"
bundle exec rails server

echo "âœ… Development environment is ready!"
echo "ğŸ“± Visit http://localhost:3000 to see your application"
