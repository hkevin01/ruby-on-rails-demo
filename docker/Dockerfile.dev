# Development Dockerfile for Rails Blog Application
FROM ruby:3.1.0-alpine

# Install system dependencies
RUN apk add --no-cache \
  build-base \
  postgresql-dev \
  postgresql-client \
  tzdata \
  nodejs \
  yarn \
  git \
  curl \
  bash \
  imagemagick \
  vim \
  less \
  && rm -rf /var/cache/apk/*

# Set working directory
WORKDIR /app

# Create app user
RUN addgroup -g 1000 -S app && \
  adduser -u 1000 -S app -G app

# Copy dependency files first for better caching
COPY Gemfile package.json yarn.lock ./
COPY src/Gemfile src/Gemfile.lock ./src/

# Install Ruby gems from project root
RUN bundle install

# Install Node.js packages from project root
RUN yarn install --frozen-lockfile && \
  yarn cache clean

# Install Rails gems from src directory
WORKDIR /app/src
RUN bundle install

# Go back to app root
WORKDIR /app

# Copy application code
COPY . .

# Set ownership
RUN chown -R app:app /app

# Switch to app user
USER app

# Create necessary directories in src
RUN mkdir -p src/tmp/pids src/tmp/cache src/tmp/sockets src/log src/storage

# Expose port
EXPOSE 3000

# Set working directory to src for Rails
WORKDIR /app/src

# Add entrypoint script
COPY --chown=app:app docker/entrypoint.sh /usr/bin/entrypoint.sh
USER root
RUN chmod +x /usr/bin/entrypoint.sh
USER app

ENTRYPOINT ["/usr/bin/entrypoint.sh"]
CMD ["rails", "server", "-b", "0.0.0.0"]
